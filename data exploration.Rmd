---
title: "Data Exploration"
author: "Gage Clawson"
date: "2/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## {.tabset .tabset-fade .tabset-pills}

###Initial data cleaning
```{r}
#Load packages
library(tidyverse)
library(tidyr)
library(RColorBrewer)
library(janitor)
library(chron)
library(sf)
library(leaflet)
library(tmap)
library(kableExtra)



```


```{r}
#Load the data
oil_accidents_raw <- read_csv("raw_database.csv")
```

```{r}
# Initial data cleanup and wrangling

oil_accidents <- oil_accidents_raw %>%
  clean_names() %>% #clean the names snake case
  select(report_number, accident_year:liquid_type, accident_city:cause_category, net_loss_barrels:restart_date_time, property_damage_costs:all_costs) %>% #select relevant columns
  separate(accident_date_time, c("day", "month", "year", "hour", "minute" ,"am_or_pm"), by = c("/", " ")) %>%  #separate the date time column
  unite("time", hour, minute, sep = ":") %>% #bring time back together
  unite("time", time, am_or_pm, sep = " ") %>% #bring time back together
  filter(accident_year != 2017) %>% #filter out the 2 2017 observations
  unite("date", year,month,day, sep = "-") %>% #make the date column again
  mutate(date = as.Date(date), pipeline_type = case_when(is.na(pipeline_type) ~ "Not Specified",
  pipeline_type == pipeline_type ~ pipeline_type), accident_city = case_when(pipeline_type == "Not Specified" & is.na(accident_city) ~ "Gulf of Mexico", pipeline_type == "Not Specified" & !is.na(accident_city) ~ accident_city))#change date to date standard internation date format. Chagne NA pipeline types to "Not Specified". Change those "Not Specified" without city names to "Gulf of Mexico" for city name

# report number 20140310 is in mongolia... should be wyoming
# report number 20140063 is in china... should be in texas
# report number 20150309 is near portugal... should be new jersey. 
# these are obvious incidents of inputting data incorrectly. Lets filter to lat and long ranges for the united states. I think all of the latitudes look fine 

oil_accidents_US <- oil_accidents %>%
  filter(accident_longitude < -60)

write.csv(oil_accidents_US, "cleaned_oil_data")
```



###Exploratory Graphs 
```{r}
sum_df <- oil_accidents %>%
  group_by(accident_year) %>%
  summarise(count_accidents = length(report_number))

## graph in shiny we will be able to select what state
ggplot(sum_df, aes(x = accident_year, y = count_accidents)) +
  geom_point() +
  geom_line()
```


###Exploratory Maps 

**Bad map**
```{r}

#http://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html 
#^link to information on how to make maps with r and how i figured this out

library(rworldmap)
library(mapdata)
library(maps)
library(ggmap)


usa <- map_data("usa")

#simple map
gg1 <- ggplot() +
  geom_polygon(data = usa, aes(x = long, y = lat, group = group), fill = "darkgreen", color = "red") +
  coord_fixed(1.3)  + 
  geom_point(data = oil_accidents_US, aes(x = accident_longitude, y= accident_latitude)) +
  theme_void()

gg1
```

**Better map**
```{r}
library("rnaturalearth")
library("rnaturalearthdata")

#https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-2.html
## make a geometry column out of the lat long columns to possibly use sf like we did in lab to map. 
oil_geom1 <- st_as_sf(oil_accidents_US, coords = c("accident_longitude", "accident_latitude"), 
    crs = 4326, agr = "constant") %>%
  select(accident_city, everything())

#make a world map layer
world <- ne_countries(scale = "medium", returnclass = "sf")

ggplot(data = world) +
    geom_sf() +
    geom_sf(data = oil_geom1, size = 1, shape = 23, fill = "darkred") +
    coord_sf(xlim = c(-180, -65), ylim = c(19, 75), expand = FALSE) +
  theme_minimal()

```

**Better maps**
```{r}
#https://rstudio.github.io/leaflet/shapes.html
leaflet(oil_accidents_US) %>%
  addTiles()  %>% # Adds bg
  addCircles(lng = ~accident_longitude, lat = ~accident_latitude, weight = 1,
    radius = ~sqrt(all_costs)*30, popup = ~accident_city
  )


# these graphs make the same thing, for this one we don't have to provide the lat, long, since it is already provided in the "geometry" column
leaflet(oil_geom1) %>%
  addTiles()  %>% # Adds bg
 addCircles(weight = 1,
    radius = ~sqrt(all_costs)*30, popup = ~accident_city
  )


```

**BEST MAP**
```{r}
# interactive map. The hovering text that shows is whichever the first column in the data frame is. Not sure how to select it so it is not the first column. 
# Just looking through the map, there are some city names missing (NAs), some wrong city names... should we try to fix this? Not sure how. Maybe getting some lat long and city data and mergining? 
tmap_mode("view")
tm_shape(oil_geom1) + tm_bubbles(size = "all_costs", alpha = 0.5, labels = "all_costs")
```

###GRAPHS

```{r}

# In the app we will change "CA" to the user selected state. 

top_ten_cost_bystate <- oil_accidents %>% 
  filter(accident_state == "CA") %>% 
  arrange(desc(all_costs)) %>% 
  head(10) %>% 
  arrange(all_costs) %>% 
  mutate(report_number = factor(report_number, levels = report_number)) %>%
  ggplot(aes(x = report_number, y = all_costs/100000)) +
  geom_col(aes(fill = accident_county)) +
  theme_bw() +
  labs(x = "", y = "Total Cost of Accident ($100,000)")+
  coord_flip() +
  theme(legend.position = "right") +
  scale_x_discrete(expand = c(0,0), labels = rev(seq(1:10))) +
  scale_y_continuous(expand = c(0,0)) +
  guides(fill=guide_legend(title="Accident County"))

top_ten_cost_bystate

```


```{r}
library(treemap)

treemap_data <- oil_accidents_US %>%
  filter(accident_state != "NA") %>%
  group_by(accident_state, pipeline_type) %>%
  summarise(all_costs = sum(all_costs), net_loss_barrels = sum(net_loss_barrels)) %>%
  ungroup()

treemap(treemap_data, index = c("accident_state", "pipeline_type"), vSize = "net_loss_barrels", vColor = "pipeline_type", type = "categorical")

```




